{
  "schema_version": "1.0",
  "tables": {
    "worlds": {
      "columns": {
        "world_id": {"type": "UUID", "primary_key": true},
        "name": {"type": "VARCHAR(255)", "indexed": true},
        "settings": {"type": "JSONB", "description": "Visual/theme configurations"},
        "timeline_mode": {"type": "ENUM('linear', 'branching', 'cyclical')"},
        "created_at": {"type": "TIMESTAMPTZ"},
        "current_timeline_version": {"type": "INTEGER", "default": 1}
      },
      "indexes": ["gin(settings)"]
    },
    
    "chapters": {
      "columns": {
        "chapter_id": {"type": "UUID", "primary_key": true},
        "world_id": {
          "type": "UUID", 
          "foreign_key": "worlds.world_id",
          "on_delete": "CASCADE"
        },
        "title": {"type": "VARCHAR(255)"},
        "order": {"type": "INTEGER"},
        "template_type": {"type": "VARCHAR(100)", "description": "Hero's journey etc."},
        "status": {"type": "ENUM('draft', 'published')"},
        "timeline_version": {"type": "INTEGER", "default": 1}
      },
      "indexes": ["world_id", "order"]
    },

    "events": {
      "columns": {
        "event_id": {"type": "UUID", "primary_key": true},
        "chapter_id": {
          "type": "UUID", 
          "foreign_key": "chapters.chapter_id",
          "on_delete": "CASCADE"
        },
        "story_time": {"type": "TIMESTAMPTZ", "description": "In-universe timestamp"},
        "title": {"type": "VARCHAR(255)"},
        "context": {"type": "JSONB", "description": "Pre/post conditions"},
        "timeline_version": {"type": "INTEGER", "default": 1}
      },
      "indexes": ["chapter_id", "story_time"]
    },

    "scenes": {
      "columns": {
        "scene_id": {"type": "UUID", "primary_key": true},
        "event_id": {
          "type": "UUID", 
          "foreign_key": "events.event_id",
          "on_delete": "CASCADE"
        },
        "narration": {"type": "TEXT"},
        "background_image_url": {"type": "TEXT"},
        "transitions": {"type": "JSONB", "description": "Links to other scenes"},
        "cultural_tags": {"type": "UUID[]", "foreign_key": "cultural_elements.element_id"},
        "validation_status": {"type": "JSONB"}
      },
      "indexes": ["event_id", "gin(cultural_tags)"]
    },

    "characters": {
      "columns": {
        "character_id": {"type": "UUID", "primary_key": true},
        "world_id": {
          "type": "UUID", 
          "foreign_key": "worlds.world_id",
          "on_delete": "CASCADE"
        },
        "name": {"type": "VARCHAR(255)", "indexed": true},
        "origin_story": {"type": "JSONB"},
        "traits": {"type": "JSONB", "description": "Dynamic attributes"},
        "knowledge_base": {"type": "UUID[]", "foreign_key": "memories.memory_id"}
      },
      "indexes": ["world_id", "gin(traits)"]
    },
 "user_badges": {
      "columns": {
        "id": {"type": "UUID", "primary_key": true},
        "user_id": {
          "type": "UUID",
          "foreign_key": "auth.users.id",
          "on_delete": "CASCADE"
        },
        "badge_name": {"type": "TEXT", "constraint": "CHECK (badge_name = 'PRIME')"},
        "awarded_at": {"type": "TIMESTAMPTZ", "default": "NOW()"}
      },
      "constraints": ["UNIQUE(user_id, badge_name)"],
      "indexes": ["user_id"]
    },
    
    "user_roles": {
      "columns": {
        "id": {"type": "UUID", "primary_key": true},
        "user_id": {
          "type": "UUID",
          "foreign_key": "auth.users.id",
          "on_delete": "CASCADE"
        },
        "is_admin": {"type": "BOOLEAN", "default": false},
        "created_at": {"type": "TIMESTAMPTZ", "default": "NOW()"}
      },
      "indexes": ["user_id"],
      "constraints": ["UNIQUE(user_id)"]
    }
  },

    "character_roles": {
      "columns": {
        "role_id": {"type": "UUID", "primary_key": true},
        "scene_id": {
          "type": "UUID", 
          "foreign_key": "scenes.scene_id",
          "on_delete": "CASCADE"
        },
        "character_id": {
          "type": "UUID", 
          "foreign_key": "characters.character_id",
          "on_delete": "CASCADE"
        },
        "emotional_state": {"type": "JSONB"},
        "relationships": {"type": "JSONB", "description": "Snapshot of rels in scene"}
      },
      "indexes": ["scene_id", "character_id"]
    },

    "dialogues": {
      "columns": {
        "dialogue_id": {"type": "UUID", "primary_key": true},
        "scene_id": {
          "type": "UUID", 
          "foreign_key": "scenes.scene_id",
          "on_delete": "CASCADE"
        },
        "character_id": {
          "type": "UUID", 
          "foreign_key": "characters.character_id",
          "on_delete": "CASCADE"
        },
        "content": {"type": "TEXT"},
        "delivery_type": {"type": "ENUM('speech_bubble', 'narration', 'thought')"},
        "sequence": {"type": "INTEGER"},
        "sentiment_score": {"type": "FLOAT"}
      },
      "indexes": ["scene_id", "character_id"]
    },

    "relationships": {
      "columns": {
        "relationship_id": {"type": "UUID", "primary_key": true},
        "character_a": {
          "type": "UUID", 
          "foreign_key": "characters.character_id",
          "on_delete": "CASCADE"
        },
        "character_b": {
          "type": "UUID", 
          "foreign_key": "characters.character_id",
          "on_delete": "CASCADE"
        },
        "type": {"type": "ENUM('family', 'friendship', 'rivalry', 'romantic')"},
        "strength": {"type": "FLOAT", "constraint": "BETWEEN 0 AND 1"},
        "history": {"type": "JSONB", "description": "Strength changes over time"}
      },
      "constraints": ["character_a < character_b"],
      "indexes": ["character_a", "character_b"]
    },

    "memories": {
      "columns": {
        "memory_id": {"type": "UUID", "primary_key": true},
        "character_id": {
          "type": "UUID", 
          "foreign_key": "characters.character_id",
          "on_delete": "CASCADE"
        },
        "content": {"type": "TEXT"},
        "acquired_in": {
          "type": "UUID", 
          "foreign_key": "scenes.scene_id",
          "on_delete": "SET NULL",
          "nullable": true
        },
        "inheritance_path": {"type": "UUID[]"},
        "relevance_score": {"type": "FLOAT"}
      },
      "indexes": ["character_id", "acquired_in"]
    },

    "cultural_elements": {
      "columns": {
        "element_id": {"type": "UUID", "primary_key": true},
        "culture": {"type": "ENUM('indian', 'russian')"},
        "name": {"type": "VARCHAR(255)"},
        "attributes": {"type": "JSONB", "description": "Visual/emotional tags"}
      },
      "indexes": ["culture", "gin(attributes)"]
    },

    "validation_rules": {
      "columns": {
        "rule_id": {"type": "UUID", "primary_key": true},
        "world_id": {
          "type": "UUID", 
          "foreign_key": "worlds.world_id",
          "on_delete": "CASCADE"
        },
        "condition": {"type": "TEXT", "description": "SQL-like where clause"},
        "error_message": {"type": "TEXT"}
      },
      "indexes": ["world_id"]
    },

    "dependencies": {
      "columns": {
        "dependency_id": {"type": "UUID", "primary_key": true},
        "source_type": {"type": "VARCHAR(50)"},
        "source_id": {"type": "UUID"},
        "target_type": {"type": "VARCHAR(50)"},
        "target_id": {"type": "UUID"},
        "impact_level": {"type": "ENUM('critical', 'moderate', 'cosmetic')"}
      },
      "indexes": ["source_type", "source_id", "target_type", "target_id"]
    }
  },

  "enums": {
    "relationship_types": ["family", "friendship", "rivalry", "romantic", "professional"],
    "delivery_types": ["speech_bubble", "narration", "thought", "song"],
    "validation_rule_scopes": ["character", "scene", "event", "world"]
  },

  "materialized_views": {
    "relationship_strength_matrix": {
      "query": "SELECT character_a, character_b, AVG(strength) FROM relationships GROUP BY character_a, character_b",
      "refresh": "HOURLY"
    },
    "cultural_pairings": {
      "query": "SELECT a.element_id as russian, b.element_id as indian, similarity(a.attributes, b.attributes) as score FROM cultural_elements a CROSS JOIN cultural_elements b WHERE a.culture = 'russian' AND b.culture = 'indian' AND similarity(a.attributes, b.attributes) > 0.5",
      "refresh": "DAILY"
    }
  }
}