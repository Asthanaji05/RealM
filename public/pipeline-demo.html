<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pipeline Demo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; line-height: 1.4; }
    textarea, input { width: 100%; padding: 8px; margin: 6px 0; }
    button { padding: 8px 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #f6f8fa; padding: 12px; border-radius: 6px; }
    .muted { color: #666; font-size: 12px; }
  </style>
  <script>
    const API_BASE = (location.port === '5173' || location.port === '5174' || location.port === '5173')
      ? 'http://localhost:5175/api'
      : '/api';

    async function plan() {
      const roughIdea = document.getElementById('rough').value.trim();
      if (!roughIdea) { alert('Enter a rough idea'); return; }
      setLoading(true);
      try {
        const res = await fetch(`${API_BASE}/plan`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roughIdea })
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Plan failed');
        document.getElementById('refined').value = json.plan.refinedPrompt;
        document.getElementById('phasePlan').value = JSON.stringify(json.plan.phasePlan, null, 2);
        document.getElementById('opening').value = json.plan.openingScene;
      } catch (e) {
        alert(e.message);
      } finally {
        setLoading(false);
      }
    }

    async function generate() {
      const roughIdea = document.getElementById('rough').value.trim();
      const refinedPrompt = document.getElementById('refined').value.trim();
      const openingScene = document.getElementById('opening').value.trim();
      const phasePlanRaw = document.getElementById('phasePlan').value.trim();
      const totalUtterances = Number(document.getElementById('n').value || 12);
      const summaryInterval = Number(document.getElementById('x').value || 4);
      let phasePlan;
      try { phasePlan = JSON.parse(phasePlanRaw); } catch { alert('Phase plan must be valid JSON'); return; }
      setLoading(true);
      try {
        const res = await fetch(`${API_BASE}/generate-story`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roughIdea, refinedPrompt, openingScene, phasePlan, totalUtterances, summaryInterval })
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Generation failed');
        document.getElementById('jsonOut').textContent = JSON.stringify(json.data, null, 2);
        document.getElementById('mdOut').textContent = json.markdown;
      } catch (e) {
        alert(e.message);
      } finally {
        setLoading(false);
      }
    }

    function setLoading(isLoading) {
      const btns = document.querySelectorAll('button');
      btns.forEach(b => b.disabled = isLoading);
      document.getElementById('status').textContent = isLoading ? 'Working…' : '';
    }
  </script>
</head>
<body>
  <h1>Story Pipeline Demo (Stub Models)</h1>
  <p class="muted">Two-step flow: Plan → Edit/Confirm → Generate</p>

  <label>Rough story idea</label>
  <textarea id="rough" rows="3" placeholder="A fantasy adventure about a knight and a rogue"></textarea>

  <div class="row">
    <div>
      <label>Total utterances (N)</label>
      <input id="n" type="number" min="2" value="12" />
    </div>
    <div>
      <label>Summary interval (x)</label>
      <input id="x" type="number" min="2" value="4" />
    </div>
  </div>

  <p>
    <button onclick="plan()">Plan</button>
    <button onclick="generate()">Generate Story</button>
    <span id="status" class="muted"></span>
  </p>

  <h2>Confirmed Plan (editable)</h2>
  <label>Refined prompt</label>
  <textarea id="refined" rows="3"></textarea>

  <label>Phase plan (JSON)</label>
  <textarea id="phasePlan" rows="8"></textarea>

  <label>Opening scene</label>
  <textarea id="opening" rows="4"></textarea>

  <h2>Outputs</h2>
  <h3>JSON</h3>
  <pre id="jsonOut"></pre>

  <h3>Markdown</h3>
  <pre id="mdOut"></pre>

  <p class="muted">Server expected at http://localhost:5175. Run: npm run server</p>
</body>
</html>





